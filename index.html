import React, { useState } from 'react';
import { Search, MapPin, ExternalLink, Star } from 'lucide-react';

export default function RedditHiddenGems() {
  const [location, setLocation] = useState('');
  const [gems, setGems] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  const searchReddit = async () => {
    if (!location.trim()) {
      setError('Please enter a location');
      return;
    }

    setLoading(true);
    setError('');
    setGems([]);

    try {
      const queries = [
        `${location} hidden gems travel`,
        `${location} secret spots visit`,
        `${location} underrated places tourist`,
        `${location} locals recommend food restaurant`,
        `${location} off beaten path`,
        `${location} best neighborhood explore`
      ];

      const travelSubreddits = [
        'travel', 'solotravel', 'backpacking', 'digitalnomad', 
        'travelhacks', 'earthporn', 'CityPorn', 'roadtrip',
        'food', 'foodporn', 'eats', 'FoodToronto', 'askNYC'
      ];

      const allResults = [];

      // Search general Reddit
      for (const query of queries) {
        const response = await fetch(
          `https://www.reddit.com/search.json?q=${encodeURIComponent(query)}&limit=20&sort=relevance`
        );
        
        if (!response.ok) throw new Error('Failed to fetch from Reddit');
        
        const data = await response.json();
        allResults.push(...data.data.children);
      }

      // Search travel-specific subreddits
      for (const sub of travelSubreddits.slice(0, 3)) {
        const response = await fetch(
          `https://www.reddit.com/r/${sub}/search.json?q=${encodeURIComponent(location)}&restrict_sr=1&limit=15&sort=relevance`
        );
        
        if (response.ok) {
          const data = await response.json();
          allResults.push(...data.data.children);
        }
      }

      const uniqueResults = Array.from(
        new Map(allResults.map(item => [item.data.id, item])).values()
      );

      // Keywords that indicate travel/local content
      const travelKeywords = [
        'visit', 'travel', 'trip', 'tourist', 'restaurant', 'food', 'eat',
        'cafe', 'bar', 'hotel', 'stay', 'explore', 'neighborhood', 'area',
        'spot', 'place', 'hidden', 'secret', 'gem', 'recommend', 'guide',
        'things to do', 'what to see', 'where to go', 'locals', 'must see',
        'itinerary', 'day trip', 'weekend', 'vacation', 'sightseeing'
      ];

      // Keywords to filter out non-travel content
      const excludeKeywords = [
        'election', 'politics', 'trump', 'biden', 'congress', 'senate',
        'crime', 'murder', 'shooting', 'arrested', 'police', 'protest',
        'tv show', 'movie', 'netflix', 'episode', 'season', 'actor',
        'game', 'gaming', 'xbox', 'playstation', 'pokemon'
      ];

      const processed = uniqueResults
        .map(post => {
          const titleLower = post.data.title.toLowerCase();
          const textLower = (post.data.selftext || '').toLowerCase();
          const combined = titleLower + ' ' + textLower;

          // Calculate travel relevance score
          const travelScore = travelKeywords.filter(kw => 
            combined.includes(kw)
          ).length;

          // Check if it contains excluded content
          const hasExcluded = excludeKeywords.some(kw => 
            combined.includes(kw)
          );

          return {
            id: post.data.id,
            title: post.data.title,
            subreddit: post.data.subreddit,
            score: post.data.score,
            numComments: post.data.num_comments,
            url: `https://reddit.com${post.data.permalink}`,
            created: new Date(post.data.created_utc * 1000).toLocaleDateString(),
            author: post.data.author,
            selftext: post.data.selftext?.substring(0, 200) || '',
            travelScore: travelScore,
            hasExcluded: hasExcluded
          };
        })
        .filter(post => 
          post.score > 3 && 
          !post.hasExcluded &&
          post.travelScore > 0
        )
        .sort((a, b) => {
          // Prioritize travel score, then upvotes
          if (a.travelScore !== b.travelScore) {
            return b.travelScore - a.travelScore;
          }
          return b.score - a.score;
        })
        .slice(0, 20);

      setGems(processed);
      
      if (processed.length === 0) {
        setError('No travel-related results found. Try a different location or add more context like "Tokyo restaurants" or "Paris neighborhoods".');
      }
    } catch (err) {
      setError('Error fetching data from Reddit. Please try again.');
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-orange-50 to-red-50 p-4">
      <div className="max-w-4xl mx-auto">
        <header className="text-center mb-8 pt-8">
          <div className="flex items-center justify-center gap-3 mb-4">
            <MapPin className="w-10 h-10 text-orange-600" />
            <h1 className="text-4xl font-bold text-gray-800">Reddit Travel Hidden Gems</h1>
          </div>
          <p className="text-gray-600">Discover local secrets, restaurants, and must-visit spots from Reddit travelers</p>
        </header>

        <div className="mb-8">
          <div className="flex gap-2">
            <div className="flex-1 relative">
              <input
                type="text"
                value={location}
                onChange={(e) => setLocation(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && searchReddit()}
                placeholder="Enter a location (e.g., Tokyo, Paris neighborhoods, Barcelona food)"
                className="w-full px-4 py-3 pr-10 rounded-lg border-2 border-gray-300 focus:border-orange-500 focus:outline-none"
              />
              <MapPin className="absolute right-3 top-3.5 w-5 h-5 text-gray-400" />
            </div>
            <button
              onClick={searchReddit}
              disabled={loading}
              className="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center gap-2 font-semibold transition-colors"
            >
              <Search className="w-5 h-5" />
              {loading ? 'Searching...' : 'Search'}
            </button>
          </div>
        </div>

        {error && (
          <div className="bg-red-100 border border-red-300 text-red-700 px-4 py-3 rounded-lg mb-6">
            {error}
          </div>
        )}

        {loading && (
          <div className="text-center py-12">
            <div className="inline-block animate-spin rounded-full h-12 w-12 border-4 border-orange-600 border-t-transparent"></div>
            <p className="mt-4 text-gray-600">Searching Reddit for travel hidden gems...</p>
          </div>
        )}

        {gems.length > 0 && (
          <div className="space-y-4">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">
              Found {gems.length} Travel Hidden Gems
            </h2>
            {gems.map(gem => (
              <div
                key={gem.id}
                className="bg-white rounded-lg shadow-md p-5 hover:shadow-lg transition-shadow"
              >
                <div className="flex items-start justify-between gap-4">
                  <div className="flex-1">
                    <a
                      href={gem.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-lg font-semibold text-gray-800 hover:text-orange-600 transition-colors block"
                    >
                      {gem.title}
                    </a>
                    {gem.selftext && (
                      <p className="text-gray-600 text-sm mt-2">
                        {gem.selftext}
                        {gem.selftext.length >= 200 && '...'}
                      </p>
                    )}
                    <div className="flex items-center gap-4 mt-3 text-sm text-gray-500">
                      <span className="flex items-center gap-1">
                        <Star className="w-4 h-4" />
                        {gem.score} upvotes
                      </span>
                      <span>ðŸ’¬ {gem.numComments} comments</span>
                      <span>r/{gem.subreddit}</span>
                      <span>{gem.created}</span>
                    </div>
                  </div>
                  <a
                    href={gem.url}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="flex-shrink-0 p-2 text-orange-600 hover:bg-orange-50 rounded-lg transition-colors"
                  >
                    <ExternalLink className="w-5 h-5" />
                  </a>
                </div>
              </div>
            ))}
          </div>
        )}

        {!loading && gems.length === 0 && !error && (
          <div className="text-center py-12 text-gray-500">
            <MapPin className="w-16 h-16 mx-auto mb-4 text-gray-300" />
            <p>Enter a location to discover travel hidden gems from Reddit</p>
            <p className="text-sm mt-2">Try: "Tokyo", "Paris restaurants", "Barcelona neighborhoods"</p>
          </div>
        )}
      </div>
    </div>
  );
}
